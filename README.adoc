= jmeter-gradle-plugin
ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]
ifndef::env-github[]
:icons: font
endif::[]
:jm_tm:     https://jmeter.apache.org/[JMeter(TM),window=_blank]
:jm_cli:    https://jmeter.apache.org/usermanual/get-started.html#override
:toc: preamble

Gradle plugin to integrate {jm_tm} tests into the gradle ecosystem. +
This plugin arose from the need of a simple to start, but easy to customize plugin. The current available plugins are either hardwired to older {jm_tm} version or configuration is not so well documented.

== Usage
=== Applying the plugin
.Kotlin DSL
[%collapsible%open]
====
[source,kotlin]
----
plugins {
  id("de.qualersoft.jmeter") version "<latest>"
}
----
====

.Groovy DSL
[%collapsible]
====
[source,groovy]
----
plugins {
  id "de.qualersoft.jmeter" version "<latest>"
}
----
====

=== Customization
The easiest way to customize the plugin is via its `jmeter` extension. +
The extension offers the following properties
[source,kotlin]
----
jmeter {
  jmxRootDir // <.>
  resultDir // <.>
  reportDir // <.>
  jmeterProperties // <.>
  globalPropertiesFile // <.>
  globalProperties // <.>
  maxHeap // <.>
  jvmArgs //<.>
}
----
[%collapsible]
====
<1> used to search for jmx files. +
Defaults to src/test/jmeter
<2> directory to which the jtl-files will be written. +
Defaults to <buildDir>/test-results/jmeter
<3> Root directory where to put the reports +
Defaults to <buildDir>/reports/jmeter
<4> [Optional] custom properties send to the local JMeter only. (for details refer to the {jm_cli}[JMeter documentation])
<5> [Optional] custom properties file send to all remote servers (for details refer to the {jm_cli}[JMeter documentation])
<6> [Optional] single key-value properties send to all remote server (for details refer to the {jm_cli}[JMeter documentation])
<7> [Optional] Specifies the maximum heap size the JVM process will start with.
<8> [Optional] additional JVM arguments that will be passed to the jvm directly.
====
These configurations will be applied to all tasks (where appropriate) and can be overridden or extended on a per task base.

== Quickstarter
[IMPORTANT]
To use the quickstarter you must have gradle installed and available on your path

=== Running a jmeter-test
1. In a folder of your choice (referred to as `root`), execute:
+
[source,shell script]
----
root> gradle wrapper init
----
This brings up the setup. We are going to create a `basic` project and using `Kotlin` as build script DSL.
2. Create the following folder structure (gradle stuff from 1. left out)
+
[source]
----
root
â”œâ”€â”€ src
â”‚   â””â”€â”€ test
â”‚       â””â”€â”€ jmeter
â”‚           â””â”€â”€ test.jmx <.>
â””â”€â”€ build.gradle.kts <.>
----
<1> default folder for jmx-files is `src/test/jmeter`
<2> build.gradle.kts is out generated by gradle we need it in next step.
3. Put the following into `build.gradle.kts`
+
[source,kotlin]
----
import de.qualersoft.jmeter.gradleplugin.task.* // <.>

plugins {
  id("de.qualersoft.jmeter") version "<latest>" // <.>
}

repositories {
  mavenCentral() // <.>
}

tasks {
  register<JMeterRunTask>("runJMeter") { // <.>
    jmxFile.set("test.jmx") // <.>
  }
}
----
<1> Import `task` package. (to save some typing later on ğŸ˜‹)
<2> Apply the plugin. (Don't forget to correct the version ğŸ˜‰)
<3> We need a repository to retrieve jmeter-library. `mavenCentral` should work in almost any case.
<4> Register a run-task and give it a name (if we wouldn't had imported the `task` package in (1), we would have to use the full qualified path)
<5> Configure the task to use our test.jmx file under `src/test/jmeter`
4. Run it by opening a cli of your choice in `root`
+
[source, shell script]
----
root> ./gradlew runJMeter
----
+
[source, shell script,title=Output]
----
...
Starting standalone test @ Sat Sep 04 18:53:51 CEST 2021 (1630774431340)
Waiting for possible Shutdown/StopTestNow/HeapDump/ThreadDump message on port 4445
Warning: Nashorn engine is planned to be removed from a future JDK release
summary =     30 in 00:00:03 =   10,0/s Avg:   206 Min:   108 Max:   345 Err:     2 (6,67%)
Tidying up ...    @ Sat Sep 04 18:53:55 CEST 2021 (1630774435185)
... end of run

BUILD SUCCESSFUL in 15s
1 actionable task: 1 executed
----

ğŸ‘ Congratulations, you run your first jmeter script with this plugin. +
ğŸ‰ 4 steps, that's it. Simple, wasn't it?

=== Generating a report
After you successfully run your first jmeter script, you might want to have a report showing some nice carts and stats.

No problem, just:

1. add the following to your `build.gradel.kts` s `task` section
+
[source,kotlin]
----
tasks {
  register<JMeterRunTask>("runJMeter") {
    jmxFile.set("test.jmx")
  }

  register<JMeterReportTask>("jmeterReport") { // <.>
    jmxFile.set("test.jmx") // <.>
  }
}
----
<1> registering a `JMeterReportTask` task (remember the include? Now it pays off ğŸ˜Š)
<2> by pointing it to our `jmx` file the plugin knows where to find everything
2. back in CLI run
+
[source, shell script]
----
root> gradlew jmeterReport
----
This generates the report under `build/reports/jmeter/Test`
[NOTE]
The directory 'Test' is retrieved from the jmx-file's name.

ğŸ‰ Voila, just 2 steps to get a report.

The `runJMeter` task must be executed before. There are two ways you can get it in one rush.

1. declare a `dependsOn` in report task
+
[source,kotlin]
----
register<JMeterReportTask>("jmeterReport") {
  jmxFile.set("test.jmx")
  dependsOn("runJMeter")
}
----
now 'runJMeter' get executed first if required
2. let run task always generate a report by
+
[source,kotlin]
----
register<JMeterRunTask>("runTest") {
  jmxFile.set("Test.jmx")
  generateReport = true
}
----
[NOTE]
If you are going to rerun the task without cleaning outputs you will get an error because the report already exists. In such cases just enable the `deleteResults` property

=== Want to modify the jmx-Script with jmeter?
No problem, just add the following task to your build-script
[source,kotlin]
----
tasks {
  register<JMeterGuiTask>("edit") {
    jmxFile.set("test.jmx")
  }
}
----
And back to CLI
[source,shell script]
----
root> gradlew edit
----
As an alternative, if you don't want to clutter your tasks-section, you can use the `jmeter`-extension
[source,kotlin]
----
jmeter {
  withGuiTask("edit") {
    jmxFile.set("test.jmx")
  }
}
----

